### Заметки о прошивке NVR hi3536ev100 на OpenIPC для целей FPV [EN](en_notes_start_hi3536ev100.md)

Данная статья неактуальна в части прошивки, используйте https://github.com/OpenIPC/wiki/blob/master/en/fpv-nvr.md, эта же стать может быть полезн а отдельными моментами。


<详细信息> <摘要>Как устроена память</摘要> Для начала, следует разобратся, как устроена память регистратора (да и камеры тоже) что нужно прошивать。 Данные хранятся на spi-flash 16mb в виде блоков mtd:

```
cat /proc/cmdline
mem=150M console=ttyAMA0,115200 panic=20 root=/dev/mtdblock3 rootfstype=squashfs init=/init mtdparts=hi_sfc:256k(boot),64k(env),2048k(kernel),8192k(rootfs),-(rootfs_data)
ls /dev/mtdb*
/dev/mtdblock0  /dev/mtdblock1  /dev/mtdblock2  /dev/mtdblock3  /dev/mtdblock4
```
Как следует из вывода, нулевой блок это загрузчик u-boot; далее идет блок для хранения переменных окружения (`printenv`, `setenv` команды пишут в ОЗУ, а `saveenv` сохраняет именно в этот блок); следом ядро uImage; потом rootfs.squashfs (неизменяемый образ файловой системы); и наконец rootfs_data или он же overlay - изменяемая часть, куда пишутся отличия от rootfs если вы изменяете какие-либо файлы. Таким образом, очистив overlay, мы "скинем" файловую систему до "дефолта":
```
sf probe 0 #выбираем устройство
sf erase 0xA50000 0x500000 #производим очистку
reset #перезагрузка
```
Как следует из вывода, нулевой блок это загрузчик u-boot; далее идет блок для хранения переменных окружения (`printenv`, `setenv` команды пишут в ОЗУ, а `saveenv` сохраняет именно в этот) ; следом ядро​​ uImage; потом rootfs.squashfs (неизменяемый образ файловой системы);和 rootfs_data 和 он же 覆盖 - 和 часть、куда пишутся отличия от rootfs если вы изменяете какие-либо файлы。 Таким образом, очистив 覆盖, мы "скинем" файловую систему до "дефолта": Еще проще сбросить до "заводских" прошивки команд ой `firstboot`。

Калькулятор адресов для команд доступен [здесь](https://openipc.org/tools/firmware-partitions-calculation)。该文件的 rootfs：8192kB，覆盖 0xA50000。 Для камеры，у которой flash 8mB，размер rootfs 5120kB，адреса будут другие，включая переменные окружения！ </详情>

Загрузчик у этого регистратора не имеет пароля, и в него можно попасть через uart/115200 бод, нажав при старте несколько раз Ctrl+C будучи подключенным к порту debug-uart регистратора через адаптер usb-uart 3v3 (ftdi, ch340). Debug uart расположен напротив разъема VGA на противоположном краю платы и подписан как gnd/tx/rx. Загрузчик нам прошивать не требуется, burn не нужен. ENV (переменные окружения) у нас отличаются от заводских, но их проще установить прямо из загрузчика построчно:
```
setenv ipaddr '192.168.0.222' #тут ip в  вашей подсети из свободных
setenv serverip '192.168.0.107' #адрес ПК с tftp сервером
setenv netmask '255.255.255.0'
setenv bootcmd 'sf probe 0; sf read 0x82000000 0x50000 0x200000; bootm 0x82000000'
setenv uk 'mw.b 0x82000000 ff 1000000;tftp 0x82000000 uImage.${soc}; sf probe 0; sf erase 0x50000 0x200000; sf write 0x82000000 0x50000 ${filesize}'
setenv ur 'mw.b 0x82000000 ff 1000000;tftp 0x82000000 rootfs.squashfs.${soc}; sf probe 0; sf erase 0x250000 0x800000; sf write 0x82000000 0x250000 ${filesize}'
setenv bootargs 'mem=192M console=ttyAMA0,115200 panic=20 root=/dev/mtdblock3 rootfstype=squashfs init=/init mtdparts=hi_sfc:256k(boot),64k(env),2048k(kernel),8192k(rootfs),-(rootfs_data)'
setenv osmem '192M'
setenv totalmem '256M'
setenv soc 'hi3536dv100'
#тут очищаем ненужные далее переменные
setenv da; setenv du; setenv dr; setenv dw; setenv dl; setenv dc; setenv up; setenv tk; setenv dd; setenv de; setenv jpeg_addr; setenv jpeg_size; setenv vobuf; setenv loadlogo; setenv appVideoStandard; setenv appSystemLanguage; setenv appCloudExAbility
saveenv #сохраняем новое окружение переменных
printenv #смотрим, все ли в порядке
```
Загрузчик у этого регистратора не имеет пароля, и в него можно попасть через uart/115200 бод, нажав при старте несколько使用 Ctrl+C 来调试 uart 调试器，然后使用 USB-uart 3v3（ftdi、ch340）。调试 uart 设备上的 VGA 设备上的 gnd/tx/rx。 Загрузчик нам прошивать не требуется, burn не нужен. ENV (переменные окружения) у нас отличаются от заводских, но их проще установить прямо из загрузька построчнално: ые env и полный дамп микросхемы (бекап заводской прошивки 16mb на случай восстановления) доступны [保存](https://github.com/OpenIPC/sandbox-fpv/tree/master/hi3536dv100/original_firmware)。

Как вы могли заметить, в переменных uk 和 хранятся макросы для прошивки uImage 和 rootfs с загрузкой их с [tftp сервера](https://pjo2.github.io/t ftpd64/), указанного в переменной serverip.您可以使用 Bootargs 和 Bootargs，以及 задает разметку файловой системы для ядра при загрузке。 Разметка отличается от привычных для камер goke/hisilicone, ядро​​ у нас как и у lite/fpv размером 2мб, однако файловая система размеро м 8мб, как у 终极。 Оставшиеся ~5мб используются оверлем (вашими изменениями файлов относительно оригинальной rootfs)。 OpenIPC 固件）。 Архив содержит ядро​​ 和 файловую систему。

Итак，после установки переменных можно приступать к прошивке оставшейся части。 tftpd 工具，包括 uImage.hi3536dv100 和 rootfs.squashfs.hi3536dv100，以及其他工具рфейс и в загрузчике запустите макрос：“跑英国”。 Должен выполниться ряд команд, из вывода которых должно следовать, что файл uImage скачался и прошился во flash.请运行“运行您的 rootfs”。 Если адреса установлены верно, скачивание застревает на "Downloading", смените адрес регистратора на соседний свободный: `setenv ipadd r'192.168.0.223'`。 Если все прошло без ошибок, делайте `reset` 和 грузитесь в операционную систему, логин root, пароль 12345.

Конфиги из каталога hi3536dv100 неактуальны, однако могут представлять интерес касаемо подключения планшета по USB/wifi/以太网热点， вы можете перенести их по аналогии в конфиги официальной прошивки или оформить отдельными bash-скриптами。 Обычно суть этих изменений в определении адреса подключаемого планшета (который является для регистратора шлюзом в слу) чаях, если планшет у нас dhcp-сервер) 和 указании этого адреса в дополнительном экземпляре wfb_rx для видеопотока 和 для телеметрийных потоков。

升级后，请执行“sysupgrade -r -k -n”。

<详细信息> <摘要>Обновление без интернета из /tmp</summary> В дальнейшем прошивку регистратора можно делать, залив в него через WinSCP ядро​​ rootfs 位于“/tmp”和“sysupgrade --kernel=/tmp/uImage”。 hi3536dv100 --rootfs=/tmp/rootfs.squashfs.hi3536dv100 -z`。 Параметр `-z` нужен если у вас нет подключения к интернету (не обновляет скрипт sysupgrade), `-n` очистит пользовательскую fs (overlay). </详情>

